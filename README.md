# 图片元数据解析插件
一款为 AstrBot 机器人开发的图片元数据解析插件，支持提取图片 Exif 信息、GPS 坐标，并通过高德地图 API 解析坐标对应的实际地址。

## 功能特性
- 提取图片基础信息：文件大小、分辨率、设备厂商/型号、拍摄时间
- 解析图片 GPS 坐标（Exif 中的地理信息）
- 通过高德地图 API 将 GPS 坐标转换为具体地址（省/市/区/街道）
- 支持等待用户发送图片（可配置超时时间）
- 容错处理：兼容二进制 Exif 数据、异常坐标、网络错误等场景

## 安装部署
### 1. 环境要求
- Python ≥ 3.8
- AstrBot 框架已安装
- 依赖包：`aiohttp` `exifread`

### 2. 安装步骤
1. 下载插件 `astrbot_plugin_img_analysis` 并进入 AstrBot WebUI进行安装
2. 配置高德地图 API Key（见下方配置说明）

## 配置说明
插件目录下的 `_conf_schema.json` 为配置文件，关键配置项如下：

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `amap_api_key` | 字符串 | 空 | 高德地图 Web 服务 API 密钥（必填，用于地址解析） |
| `timeout_seconds` | 整数 | 30 | 等待用户发送图片的超时时间（秒） |
| `prompt_send_image` | 字符串 | "请发送要解析的图片" | 引导用户发送图片的提示语 |
| `prompt_timeout` | 字符串 | "解析请求已超时，请重新发送命令" | 用户超时未发图的提示语 |
| `max_exif_show` | 整数 | 20 | 单次展示的最大 Exif 字段数量（避免内容过长） |

### 高德地图 API Key 申请
1. 访问 [高德开放平台](https://lbs.amap.com/)，注册并登录账号
2. 进入「控制台」→「应用管理」→「创建应用」（应用类型选择「Web服务」）
3. 为应用添加「Web服务API」权限，生成 API Key
4. 将生成的 Key 填入配置文件的 `amap_api_key` 字段

## 使用方法
### 指令调用
在 QQ 聊天中发送以下指令：
```
/imgmeta
/解析
/图片元数据
```

### 使用流程
1. 发送 `/imgmeta` 指令，机器人会提示「请发送要解析的图片」
2. 直接发送图片（或引用包含图片的消息），机器人会自动解析：
   - 基础信息：文件大小、分辨率、拍摄设备、拍摄时间
   - GPS 信息：纬度/经度，及对应的实际地址（需配置高德 API Key）
   - Exif 详细数据：最多展示 20 个字段（可配置）

### 示例
```
【基础信息】
文件大小(KB)：1234.56
文件大小(MB)：1.21
宽度：1920 像素
高度：1080 像素
设备厂商：Apple
设备型号：iPhone 14
拍摄时间：2025:12:15 10:30:00

【GPS信息】
纬度：39.908823° N，经度：116.397470° E
解析地址：北京市东城区东长安街1号
附近兴趣点：天安门（旅游景点）

【Exif详细数据】
Image_ExifVersion：0230
Image_Orientation：1
Image_ResolutionUnit：2
（共25个字段，仅展示前20个）
```

## 常见问题
### 1. 提示「未配置高德地图API Key」
- 检查 `_conf_schema.json` 中 `amap_api_key` 是否填写正确
- 确认 API Key 已开启「Web服务API」权限

### 2. GPS 解析显示「无GPS信息」
- 图片可能是压缩图（社交平台发送的图片会删除 Exif/GPS 信息）
- 拍摄设备未开启定位，或图片本身无 GPS 数据

### 3. 图片下载失败
- 检查机器人网络是否正常，能否访问 QQ 图片服务器
- 确认图片链接有效（非过期/失效链接）

### 4. 地址解析失败
- 检查 GPS 坐标是否有效（纬度 [-90,90]，经度 [-180,180]）
- 确认高德 API Key 未超限（免费账号日调用量 30 万次）
- 检查网络是否能访问高德 API（`https://restapi.amap.com`）

## 插件结构
```
astrbot_plugin_img_analysis/
├── main.py               # 插件核心代码
└── _conf_schema.json     # 配置文件
```

## 版本信息
- 版本：1.0.0
- 适配平台：AstrBot（QQ 平台）
- 最后更新：2025-12-15

## 免责声明
- 本插件仅用于解析图片元数据，请勿用于非法用途
- GPS 地址解析依赖高德地图 API，需遵守高德开放平台使用规范
- 插件仅读取图片的 Exif 信息，不会上传/存储图片内容